---
title: "Workspace management (in Beta)"
sidebarTitle: "Overview"
description: "Use Mage in multiple workspaces in the cloud"
---

We recommend running your production environment in the cloud. Mage has a built in
workspace manager that can be enabled in production. This feature is similar to the
[multi-development environments](/production/developing-in-the-cloud/cloud-dev-environments/overview), but
there are settings that can be shared across the workspaces. For example, the project owner
can set workspace level permissions for users. The current additional features supported are:

* workspace level permissions
* workspace level git settings

still to come...

* common workspace metadata file
* customizable permissions and roles

## Setup

In order to start using workspace management, you will first need to create a "main project". The
main project is the parent project that will handle the management of all the workspaces. To create
a main project, you will need to set the `PROJECT_TYPE` environment variable.

If you want to use workspace level permissions, you will also need to enable user authentication
and [provide an external database](/production/configuring-production-settings/overview#databases)
(not the default SQLite DB) that will be shared among your workspaces. To enable user authentication,
you will need to set the `REQUIRE_USER_AUTHENTICATION` variable.

| Variable Name | Value |
| --- | --- |
| `PROJECT_TYPE` | `main` |
| `CLUSTER_TYPE` | `k8s` |
| `REQUIRE_USER_AUTHENTICATION` | `1` |
| `MAGE_DATABASE_CONNECTION_URL` | `postgresql+psycopg2://...` |

Depending on your cloud environment, Mage may expect additional environment variables.
Mage currently natively supports creating workspaces in these cloud providers:

<AccordionGroup>

<Accordion title="Kubernetes">
### Setup

We recommend using Helm to set up your Kubernetes cluster. You can find our Mage Helm
documentation [here](/production/deploying-to-cloud/using-helm). You will need to create
a persistent volume for your cluster.

You will need to include your Kubernetes namespace as an environment variable when setting
up your Kubernetes deployment. Here is a sample config for the `values.yaml` file for the
Helm chart:

```yaml
volumes:
  - name: mage-fs
    persistentVolumeClaim:
      claimName: gke-mage-pvc


env:
  - name: KUBE_NAMESPACE
    valueFrom:
      fieldRef:
        fieldPath: metadata.namespace
  - name: PROJECT_TYPE
    value: main
  - name: MAGE_DATABASE_CONNECTION_URL
    value: <database_connection_url>
  - name: REQUIRE_USER_AUTHENTICATION
    value: "1"
```

### Permissions

Once your cluster and initial deployment is created, you will also need to give your
Kubernetes service account some permissions in order to create the necessary resources.
You can run the folliwng `kubectl` command to create the `ClusterRole` required for 
managing the Kubernetes resources.

```bash
cat <<EOF | kubectl apply -f -
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: manage-role
rules:
  - apiGroups:
      - ""
      - apps
    resources:
      - nodes
      - services
      - statefulsets
      - statefulsets/scale
      - persistentvolumes
      - ingresses
      - configmaps
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
EOF
```

Once the cluster role is created, you will need to bind the role to the 
service account. You will need to change the service account name if it is not `default`:

```bash
kubectl create clusterrolebinding manage-role-binding \
  --clusterrole=manage-role  \
  --serviceaccount=default:default
```

### Configuration

When creating a new Kubernetes workspace, you can configure the following Kubernetes settings:

<Frame>
    <img
        alt="Kubernetes configuration"
        src="https://github.com/mage-ai/assets/blob/main/production/workspaces/workspaces-k8s-settings.png?raw=true"
		/>
</Frame>

| Field | Description |
| --- | --- |
| Workspace name | Name of workspace. This name will be used to create all resources for the workspace. |
| Service account name | Kubernetes service account to use to create the resources. Defaults to current pod's service account name. |
| Ingress name | Name of ingress to add the new workspace to. See more information about the ingress set up below. |
| Storage class name | Name of storage class to provision storage from for the stateful set. Defaults to current pvc's storage class name. |
| Storage request size | Amount of storage to provision for the persistent volume claim (in GB). Defaults to current pvc's storage request. |
| Access mode | Access mode for persistent volume claim. [More info in Kubernetes docs.](https://kubernetes.io/docs/concepts/storage/persistent-volumes/#access-modes) Defaults to current pvc's access mode. |
| Configure container | Customize the configuration for the container. [Configuration options](https://github.com/kubernetes-client/python/blob/master/kubernetes/docs/V1Container.md) |

#### Lifecycle management

Mage provides some support for managing the lifecycle of the workspace. For Kubernetes workspaces, Mage
supports the following lifecycle management options:

<AccordionGroup>
<Accordion title="Auto termination">

When auto termination is enabled, Mage will automatically stop the workspace after the specified amount of time.

</Accordion>

<Accordion title="Pre start script">

You can select a Python pre start script that will be run before the container is started. The script must
must be a valid Python script with a `get_custom_configs` method that returns a dictionary. The `get_custom_configs`
method will be passed the container config of the workspace as an argument. Here is an example script:

```python
### example_pre_start.py

from typing import Dict

def get_custom_configs(mage_container_config: Dict) -> Dict:
    current_env = config.get('env', [])
    current_env.append({
        'name': 'RANDOM_ENV_VAR',
        'value': 'HI HELLO',
    })
    config['env'] = current_env
    return config
```

This script will add an environment variable to the container config before the container is started. This will be run
when the Kubernetes pod is restarted as well. The returned Dictionary must be a valid Kubernetes container config. You
can find the schema for a container config [here](https://github.com/kubernetes-client/python/blob/master/kubernetes/docs/V1Container.md)

</Accordion>

<Accordion title="Post start hook">

You can also configure a post start hook that will be run after the container is started. This setting leverages the 
native Kubernetes container lifecycle [`PostStart` hook](https://kubernetes.io/docs/tasks/configure-pod-container/attach-handler-lifecycle-event/).
Mage provides two configuration fields:

1. `command`: corresponds to the Kubernetes `lifecycle.postStart.exec.command` field. This field is required if you are
using a post start hook. This can be a string command or a list.
2. `hook_path`: Mage will mount the file specified by this setting to the container. You can reference this fild in your
post start `command` to perform more advanced operations. The path of this field will be `/app/<file_name>` in the container.

Example:

`command`: ["/bin/sh", "-c", "/app/example_post_start.sh"]
`hook_path`: /home/src/my_mage_project/example_post_start.sh

</Accordion>

</AccordionGroup>

### Ingress

When an ingress is provided, the `MAGE_BASE_PATH` environment variable will be set automatically 
to the name of the workspace. Thus, the workspace will be accessible at the `/<workspace-name>` path.

Providing an ingress name will add the workspace to the ingress rules like this:

```
spec:
  rules:
    - host: "your host"
      http:
        paths:
          ...
          - path: /<workspace-name>
            path_type: Prefix
            backend:
              service:
                name: <service-name>
                port: 6789
```
</Accordion>

</AccordionGroup>

still to come...

* Amazon ECS
* Google Cloud Run

If you run into issues deploying your infrastructure, feel free to reach out in our
[Slack](https://www.mage.ai/chat).

<img src="https://github.com/mage-ai/assets/blob/main/multi-dev-cloud-env.jpg?raw=true" />

### User management

<Note>
    Only the global owner can manage users from the workspace management page.
</Note>

If you enabled user authentication and connected an external database, you will be able to use
project level permissions for your workspaces. When a workspace is created, project level roles will
be automatically created for your workspaces as well. Click on the "Users" tab in the sidebar to view
and manage user roles.

<Frame>
    <img
        alt="Workspaces users"
        src="https://github.com/mage-ai/assets/blob/main/production/workspaces/workspaces-users.png?raw=true"
    />
</Frame>

If you click on a user or create a new user, you should see all your workspaces and the role that the
user has for each workspace. If you want to give a user global permissions, then you can add a global role
on the left hand side. Otherwise, you can set project level permissions on the right.

<Frame>
    <img
        alt="Workspaces users"
        src="https://github.com/mage-ai/assets/blob/main/production/workspaces/workspaces-user-management.png?raw=true"
    />
</Frame>

### Settings

In the settings tab, you can adjust the project metadata for the main project. This tab will be mostly useful
if any of the initial settings are incorrect. In the future, we plan on allowing users to configure their
workspace metadata from the settings page.


