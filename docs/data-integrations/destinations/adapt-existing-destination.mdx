---
title: "Adapt an existing destination"
description: "Mage builds data integrations from Singer targets, so if there's a destination you want to use that isn't supported yet, you can adapt it yourself!"
---

## Getting started

Mage destinations live in the `/mage_integrations/mage_integrations` folder. To add a new destination, you'll need to create a new folder in the `/destinations` subdirectory.

The folder name should be the name of the target. For existing destinations, that starts with pulling in the GitHub repo for the target. For example, for the [GitHub target](https://github.com/MeltanoLabs/target-github), we would:

```bash
cd mage_integrations/mage_integrations
git clone https://github.com/jwills/target-duckdb destinations/duckdb
```

The result:

```
.
â”œâ”€â”€ CHANGELOG.md
â”œâ”€â”€ LICENSE
â”œâ”€â”€ Makefile
â”œâ”€â”€ README.md
â”œâ”€â”€ sample_config.json
â”œâ”€â”€ sample_logging.conf
â”œâ”€â”€ setup.py
â”œâ”€â”€ target_duckdb
â”‚Â Â  â”œâ”€â”€ __init__.py
â”‚Â Â  â”œâ”€â”€ db_sync.py
â”‚Â Â  â”œâ”€â”€ logger.py
â”‚Â Â  â””â”€â”€ logging.conf
â””â”€â”€ tests
    â”œâ”€â”€ integration
    â””â”€â”€ unit
```

## Configuring the destination

We now have a folder with our target and a bunch of miscellaneous files. Our first step is to clear out everything we _don't_ need. We can delete all files/folders other than `target_your_destination` and `tests`, but hold onto anything that looks like a `config.json` file or a sample config.

Next, we need to create a configuration file and an init file:

```bash
mkdir destinations/duckdb/templates \
&& touch destinations/duckdb/templates/config.json \
&& touch destinations/duckdb/__init__.py
```

We can now populate our `config.json` file with the sample from the target. In the GitHub example, this is `config.sample.json`. It looks like this:

```json
{
    "access_token": "abcdefghijklmnopqrstuvwxyz1234567890ABCD",
    "repository": "singer-io/target-stitch",
    "start_date": "2021-01-01T00:00:00Z",
    "request_timeout": 300,
    "base_url": "https://api.github.com"
}
```

These are the parameters we'll need to configure our target. After cleanup, our tree looks like:

```
.
â”œâ”€â”€ __init__.py
â”œâ”€â”€ target_github
â”‚Â Â  â”œâ”€â”€ __init__.py
â”‚Â Â  â”œâ”€â”€ authenticator.py
â”‚Â Â  â”œâ”€â”€ client.py
â”‚Â Â  â”œâ”€â”€ organization_streams.py
â”‚Â Â  â”œâ”€â”€ repository_streams.py
â”‚Â Â  â”œâ”€â”€ schema_objects.py
â”‚Â Â  â”œâ”€â”€ scraping.py
â”‚Â Â  â”œâ”€â”€ streams.py
â”‚Â Â  â”œâ”€â”€ target.py
â”‚Â Â  â”œâ”€â”€ tests
â”‚Â Â  â”œâ”€â”€ user_streams.py
â”‚Â Â  â””â”€â”€ utils
â””â”€â”€ templates
    â””â”€â”€ config.json
```

Now, we need to override some methods in the class to make it work with Mage. This is where things get fun! Copy and paste the following template into `your_target/__init__.py`:

```python
from typing import List

from mage_integrations.destinations.base import Source, main
from mage_integrations.destinations.catalog import Catalog

class YourSource(Source):
    def discover(self, streams: List[str] = None) -> Catalog:
        pass

    def sync(self, catalog: Catalog) -> None:
        pass
    
    def test_connection(self) -> None:
        client = YourSource(YOUR_CONFIG)
        client.close()

if __name__ == "__main__":
    main(YourSource, schemas_folder="target_your_target/schemas")
```

Replace YourSource with the name of your destination, e.g. `Github` for Github, and `target_your_target` with the name of your target, e.g. `target_github`.

### Overwrite target methods

Our goal is to overwrite the `discover` and `sync` methods to make them work with Mage. Discover is likely in `target_your_target/discover.py` and sync is likely in `target_your_target/sync.py`. It requires a bit of nuance, but our job is to look through the existing Singer target, understand how the `sync` and `discover` methods were implemented, then execute them in Mage `__init__.py` under the corresponding method. This is necessarily different for every target, since each project is entirely independent.

Don't forget to use absolute imports for these files. [HubSpot](https://github.com/mage-ai/mage-ai/tree/master/mage_integrations/mage_integrations/destinations/hubspot) is another good example of a completed target.

### Add test connection method

We need a `test_connection` method to enable testing the target in the Mage UI. This is a simple method that instantiates the target and closes it. Just replace `YourSource` with the destination class, e.g. `Github` and provide the configuration arguments to the target. Here's a [good example](https://github.com/mage-ai/mage-ai/blob/master/mage_integrations/mage_integrations/destinations/sftp/__init__.py#L28-L35) from the sFTP target.

```python
def test_connection(self) -> None:
        client = SFTPConnection(host=self.config['host'],
                                username=self.config['username'],
                                password=self.config['password'],
                                private_key_file=self.config.get(
                                    'private_key_file'),
                                port=self.config['port'])
        client.close()
```

### Overwrite `write_schema` method

Finally, we need to overwrite the `write_schema` method in the `target_your_target/sync.py` file. Add the following import:

`from mage_integrations.destinations.messages import write_schema`

Now, switch out the default function (likely `singer.write_schema`) for the mage function using the default arguments. Here's an example:

```python
  write_schema(
        stream_name=catalog['target_stream_id'],
        schema=schema,
        key_properties=catalog.get('key_properties', ['id']),
        bookmark_properties=catalog.get('bookmark_properties'),
        disable_column_type_check=catalog.get('disable_column_type_check'),
        partition_keys=catalog.get('partition_keys'),
        replication_method=catalog.get('replication_method'),
        stream_alias=catalog.get('stream_alias'),
        unique_conflict_method=catalog.get('unique_conflict_method'),
        unique_constraints=catalog.get('unique_constraints'),
    )
```

### Add logging

To add verbose logging to Mage, add a logger argument each target file, `target_github/sync.py`, `target_github/discover.py`:

```python
def discover(client, logger=None):
    """
    Run the discovery mode, prepare the catalog file and return catalog.
    """
    mage_logger = logger or LOGGER
```

Then replace usage of `LOGGER` with `mage_logger`.

```python

for stream_name, schema_dict in schemas.items():
        try:
            schema = Schema.from_dict(schema_dict)
            mdata = field_metadata[stream_name]
        except Exception as err:
            # These were LOGGER previously
            mage_logger.error(err)
            mage_logger.error('stream_name: %s', stream_name)
            mage_logger.error('type schema_dict: %s', type(schema_dict))
            raise err
```

This will enable Mage to better log Singer targets! ðŸ¥³

## Add destination to the Mage UI

Add the new destination to the `SOURCES` list constant in [this](https://github.com/mage-ai/mage-ai/blob/master/mage_ai/data_integrations/destinations/constants.py) file

This will make your new destination visible in the Mage UI.

## Test your destination

Sources should be tested both in the console and via the UI. Follow the directions [here](https://github.com/mage-ai/mage-ai/blob/master/mage_integrations/README.md#testing-sync-locally) to configure a lightweight test of your destinations targets via a bash terminal and the Mage UI in the dev docker instance. This entails:

- Setting up a sample destination and connection locally.
- Running the target directly, via Python.
- Writing to an intermediate file to inspect the output.
- Performing an end-to-end sync.

## Populate `README.md`

Finally, populate a README file in the destination folder, e.g. `/destinations/duckdb/README.md`. This should include:

* The name/logo of the target.
* A configuration section.
* The method for accessing/creating an API key to use with the folder.
* See [HubSpot](https://github.com/mage-ai/mage-ai/tree/master/mage_integrations/mage_integrations/destinations/hubspot) or [GitHub](https://github.com/mage-ai/mage-ai/tree/master/mage_integrations/mage_integrations/destinations/github) for examples.
